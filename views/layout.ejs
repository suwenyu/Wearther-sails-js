<!DOCTYPE html>
<html>
  <head>
    <title>Wearther</title>

    <!-- Viewport mobile tag for sensible mobile support -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <script src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/FB.js"></script>
    <!-- <script src="/js/main.js"></script> -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!--
        Stylesheets and Preprocessors
        ==============================

        You can always bring in CSS files manually with `<link>` tags, or asynchronously
        using a solution like AMD (RequireJS).  Or, if you like, you can take advantage
        of Sails' conventional asset pipeline (boilerplate Gruntfile).

        By default, stylesheets from your `assets/styles` folder are included
        here automatically (between STYLES and STYLES END). Both CSS (.css) and LESS (.less)
        are supported. In production, your styles will be minified and concatenated into
        a single file.

        To customize any part of the built-in behavior, just edit `tasks/pipeline.js`.
        For example, here are a few things you could do:

            + Change the order of your CSS files
            + Import stylesheets from other directories
            + Use a different or additional preprocessor, like SASS, SCSS or Stylus
    -->
    <!--STYLES-->
    <link rel="stylesheet" href="/styles/custom.min.css">
    <link rel="stylesheet" href="/styles/font-awesome.min.css">
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/materialize.css">
    <link rel="stylesheet" href="/styles/materialize.min.css">
    <link rel="stylesheet" href="/styles/perfect-scrollbar.css">
    <link rel="stylesheet" href="/styles/prism.css">
    <link rel="stylesheet" href="/styles/style.min.css">
    <!--STYLES END-->
    <script type="text/javascript">
      window.overlord = { csrf: "<%= _csrf %>" };
    </script>
    
  </head>

  <body>
    <div class="row hide-on-large-only"></div>
    <div class="panel">
      <div class="row">
        <div class="col m1"></div>
        <div class="col s12 m3 weather_board" >
            <div class="wea_addr" id="countryName">台北市 文山區</div>
            <div class="row wea_temp">
              <div class="col s2 i_am_nothing"></div>
              <div class="col s8 m12 wea_num" id="temp">29<div class="temp_unit">°C</div></div>
              <!-- <div class="col s3 m6 temp_unit" >°C</div> -->
              <div class="col s12 wea_detail" id="description">晴時多雲</div>
            </div>
            <div class="wea_wet">
              <div class="wea_title">降雨機率</div>
              <div id="chanceofrain" class="wea_content">60%</div>
            </div>
            <div class="wea_quality">
              <div class="wea_title">空氣AQI*</div>
              <div class="wea_content" id="aqi">不健康</div>
              <div class="aqi_hint"><p>-----------</p><p>AQI: 空氣質量指數</p></div>
            </div>
        </div>
        <div class="col s12 m8" >
          <div id="nav_desk" class="row">
            <div class="col s12 hide-on-med-and-down">
              <div class="row">
                <div class="col s1">
                  <a href="/weather/">
                    <i class="fa fa-home fa-lg" ></i>
                  </a>
                </div>
                <div class="col s1">
                  <a href="/posts/top">
                    <i class="fa fa-compass fa-lg" ></i>
                  </a>
                </div>
                <div class="col s4 searchfield">
                  <a href="#">
                    <i class="fa fa-search fa-lg"></i>
                  </a>
                </div>
                <div class="col s3 offset-s2 profile">
                <% if (session.authenticated) { %>
                    <% if(session.User.fbid) { %>
                        <img src="https://graph.facebook.com/<%- session.User.fbid %>/picture?type=large&return_ssl_results=1" height="50" width="50" alt="" class="img-circle ">
                    <% } %>
                    
                  <a href="/account/index/<%= session.User.id %>"><%= session.User.name %> </a> 
                  <% } %>
                  <% if (!session.authenticated) { %>
                    <a id="myBtn" href="#modal1"><i class="fa fa-sign-in" aria-hidden="true"></i> Sign in</a>
                   <% } %>
                </div>
              </div>
              <div class="col s11 hr"></div>
            </div>
          </div>
          
              <%- body %>
        </div>
      </div>
    </div>


<!-- Modal -->
  <div class="modal" id="modal1" style="max-height:90%">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header" style="padding:0px 50px;">
          <!-- <button type="button" class="close" data-dismiss="modal">&times;</button> -->
          <h4><i class="fa fa-lock" aria-hidden="true" style="color:black"></i> Login</h4>
        </div>
        <div class="modal-body" style="padding:0px 50px 0px 50px;">
          <form role="form" action="/account/login" method="POST" >
            <div class="row margin">
              <div class="input-field col s12">
                <i class="fa fa-user fa-lg prefix" aria-hidden="true" style="color:black;line-height: 50px;"></i>
                <input id="email" type="text" name="email">
                <label for="email" class="center-align">Email</label>
              </div>
            </div>
            <div class="row margin">
              <div class="input-field col s12">
                <!-- <i class="mdi-action-lock-outline prefix"></i> -->
                <i class="fa fa-key fa-lg prefix" aria-hidden="true" style="color:black;line-height: 50px;"></i>
                <input id="password" type="password" name="password">
                <label for="password">Password</label>
              </div>
            </div>
            
            <div class="row">          
              <div class="input-field col s12 m12 l12  login-text">
                  <input type="checkbox" id="remember-me" />
                  <label for="remember-me">Remember me</label>
              </div>
            </div>

            <div class="row">
              <div class="col s4 offset-s4">
                <button type="submit" class="btn btn-success btn-block" style="width:100%"><span class="glyphicon glyphicon-off"></span> Login</button>
              </div>
            </div>
          </form>
          <div id="fb-root" class="row">
            <div class="col s8 offset-s2">
              <a class="fb-login btn btn-block btn-social btn-facebook">
              <span class="fa fa-facebook"></span> Sign in with Facebook
              </a>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger btn-default pull-left modal-close" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span> Cancel</button>
          <p>Not a member? <a href="/account/new">Sign Up</a></p>
        </div>
      </div>
      
    </div>
  </div> 


<div id="modal2" class="modal" style="max-height:90%">
  <div class="modal-content">
    <!-- <h4>Modal Header</h4> -->
    <!-- <p>A bunch of text</p> -->
    <div id="uploadblock" class="modalupload" style="height: 300px;text-align: center;">
      <div class="uploadicon">
      <i class="fa fa-upload fa-5x" aria-hidden="true"></i>
      <p>點此上傳你的相片</p>
      <input type="file" id="uploadfile" style="display: none;">
      </div>
    </div>
    
    <form action="/posts/upload" method="post" enctype="multipart/form-data">
          
          <div class="ui form">
            <div class="field">
              <label style="font-size:16px">請寫下您今天的穿搭衣服：</label>
              <textarea class="form-control" type="text" name="foo" id="exampleTextarea" rows="10"></textarea>
            </div>
            <div class="ui divider"></div>
            <div class="field">
                 <label style="font-size:16px">請上傳您的照片檔:</label>
               <label class="custom-file">
                 <input type="file" id="file" class="custom-file-input" name="avatar">
                 <span class="custom-file-control"></span>
               </label>
            </div>
            
          </div>

          <div class="ui divider"></div>
          
          <button class="btn btn-info" type="submit">Submit</button>

      </form>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">cancel</a>
  </div>
</div>

<!-- <div id="modal1" class="modal">
  <div class="modal-content">
    <div class="modalupload" style="height: 300px;text-align: center;">
      <i class="fa fa-upload fa-5x" style="color: #ccc" aria-hidden="true"></i>
    </div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">上傳</a>
  </div>
</div> -->


<script>
$(document).ready(function(){
    
    $('#modal1').modal();
    $('#modal2').modal();

   $('.fb-login').on('click',function(){
    Login();
   });
});
</script>


<script>
  $( document ).ready(function() {

  getLocation().then(function(result){
    return getaddress(result);
  }).then(function(result){

    // return getWeather(result);
  // }).then(function(result){
    
    return getAQI(result);
  }).then(function(result){
    
    // console.log(result);

    return worldweatherapi(result);
  }).then(function(result){

    return appendData(result);
  }).then(function(result){

    return deliverData(result);
  }).then(function(result){
    
    // console.log(result);
    return appendClothes(result);
  }).then(function(result){
    console.log('success');
  });
});


function getaddress(result){
  return new Promise(function(resolve, reject){
    $.ajax({
      method:'GET',
      url:'https://maps.googleapis.com/maps/api/geocode/json?latlng='+result.location.lat+','+result.location.lng+'&key=AIzaSyD2hw_JtqQA44hpglku1Nh1bPQte110PGc'
    }).done(function(data){
      result['location'].city = data.results[0].address_components[4].long_name;
      result['location'].dist = data.results[0].address_components[3].long_name;
      resolve(result);
    });
  });
}


function worldweatherapi(result){
  return new Promise(function(resolve, reject){
    console.log(result.location.lng);
    $.ajax({
      method:'GET',
      url: 'https://api.worldweatheronline.com/premium/v1/weather.ashx?key=be8f810e29c54a748be73359172705&q='+parseFloat(result.location.lat).toFixed(2)+','+parseFloat(result.location.lng).toFixed(2)+'&format=json&num_of_days=1&includelocation=yes'
    }).done(function(data){
      var weather_time = getCurrentTime();

      console.log(data.data.weather[0].hourly[weather_time].tempC);

      var new_weather = {};
      new_weather['temp'] = data.data.weather[0].hourly[weather_time].tempC;
      new_weather['chanceofrain'] = data.data.weather[0].hourly[weather_time].chanceofrain;
      new_weather['weatherDesc'] = data.data.weather[0].hourly[weather_time].weatherDesc[0].value;
      result['new_weather'] = new_weather;

      resolve(result);
    });
  });
}

function addZero(i) {
    if (i < 10) {
        i = "0" + i;
    }
    return i;
}



function getCurrentTime(){
  var d = new Date();
  var h = addZero(d.getHours());
  var m = addZero(d.getMinutes());

  var time = parseInt(h*100) + parseInt(m);
  console.log(time);
  if(time < 130)
    return 0;
  else if(time < 430)
    return 1;
  else if (time < 730)
    return 2;
  else if (time < 1030)
    return 3;
  else if (time < 1330)
    return 4;
  else if (time < 1630)
    return 5;
  else if (time < 1930)
    return 6;
  else if (time < 2230)
    return 7;
  else
    return 0;
}

function appendClothes(result){
  return new Promise(function(resolve, reject){
    $('#recom_body > div').remove();
    $('#recom_foot > div').remove();

    result.recom_body.forEach(function(data){
      $('#recom_body').append('<div>'+ data +'</div>');
    });
    result.recom_foot.forEach(function(data){
      $('#recom_foot').append('<div>'+ data +'</div>');
    });


    resolve(result);
  });
}


function deliverData(result){
  return new Promise(function(resolve, reject){
    $.ajax({
      method:'POST',
      url:'/weather/clothes',
      data:result
    }).done(function(result){
      console.log(result);
      resolve(result);
    });
  });
}

function appendData(result){
  return new Promise(function(resolve, reject){
    // result.weather_data.temp = Math.round(result.weather_data.temp);
    $('#countryName').hide().html(result.location.city +"  "+ result.location.dist).fadeIn();
    $('#temp').hide().html(result.new_weather.temp + '<div class="temp_unit">°C</div>').fadeIn();
    $('#description').hide().html(result.new_weather.weatherDesc).fadeIn();
    $('#aqi').hide().html(result.aqi.country_aqi).fadeIn();
    $('#chanceofrain').hide().html(result.new_weather.chanceofrain + "%").fadeIn();
    resolve(result);
  });
}


function getAQI(result){
  return new Promise(function(resolve, reject){
    $.ajax({
      method:'GET',
      url:'https://api.breezometer.com/baqi/?lat='+result.location.lat+'&lon='+result.location.lng+'&key=48146dcc571e4588b368d2531eac97f0&fields=country_aqi,country_color'
    }).done(function(data){
      result['aqi'] = data;
      resolve(result);
    });
  });
}


function getWeather(result){
  return new Promise(function(resolve , reject){
    $.ajax({
      method:'GET',
      url:"http://api.openweathermap.org/data/2.5/weather?lat="+result.location.lat+"&lon="+result.location.lng+"&APPID=ed87a12dc271a93d5f2d75fa2e4f426b"
    }).done(function(data){
      var weather_data = {}
      weather_data['countryname'] = data.name;
      weather_data['temp'] = data.main.temp/10;
      weather_data['humidity'] = data.main.humidity;
      weather_data['wind'] = data.wind.speed;
      weather_data['description'] = data.weather[0].description;
      weather_data['condition'] = data.weather[0].main
      weather_data['rain'] = data.weather[0].rain

      result['weather_data'] = weather_data;
      resolve(result);
    })
  });
}


function getLocation(){
  return new Promise(function(resolve, reject){

    <% if (session.location) { %>
      var lat = "<%- session.location.lat %>";
      var lng = "<%- session.location.lng %>";
    <% } else{ %>
      var lat = undefined;
      var lng = undefined;
    <% } %>
    console.log(lat , lng);
    if(lat == undefined){
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(location_data){
          var loca_data = {};
          var location = {};
          location['lat'] = location_data.coords.latitude;
          location['lng'] = location_data.coords.longitude;
          loca_data['location'] = location;
          console.log(loca_data);

          resolve(loca_data);
        });
     }
    }
    else{
      var loca_data = {};
      var location = {};
      location['lat'] = lat;
      location['lng'] = lng;
      loca_data['location'] = location;
      console.log(loca_data);

      resolve(loca_data);lng
    }

    
    


  });
}
</script>

<script>
$('#uploadblock').on('click',function(){
  // alert("hi!");
  $('#uploadfile').click();
});
</script>

    <!--
        Client-side Templates
        ========================

        HTML templates are important prerequisites of modern, rich client applications.
        To work their magic, frameworks like Backbone, Angular, Ember, and Knockout require
        that you load these templates client-side.

        By default, your Gruntfile is configured to automatically load and precompile
        client-side JST templates in your `assets/templates` folder, then
        include them here automatically (between TEMPLATES and TEMPLATES END).

        To customize this behavior to fit your needs, just edit `tasks/pipeline.js`.
        For example, here are a few things you could do:

            + Import templates from other directories
            + Use a different template engine (handlebars, jade, dust, etc.)
            + Internationalize your client-side templates using a server-side
              stringfile before they're served.
    -->

    <!--TEMPLATES-->
    
    <!--TEMPLATES END-->


    <!--

      Client-side Javascript
      ========================

      You can always bring in JS files manually with `script` tags, or asynchronously
      on the client using a solution like AMD (RequireJS).  Or, if you like, you can
      take advantage of Sails' conventional asset pipeline (boilerplate Gruntfile).

      By default, files in your `assets/js` folder are included here
      automatically (between SCRIPTS and SCRIPTS END).  Both JavaScript (.js) and
      CoffeeScript (.coffee) are supported. In production, your scripts will be minified
      and concatenated into a single file.

      To customize any part of the built-in behavior, just edit `tasks/pipeline.js`.
      For example, here are a few things you could do:

          + Change the order of your scripts
          + Import scripts from other directories
          + Use a different preprocessor, like TypeScript

    -->

    <!--SCRIPTS-->
    <script src="/js/dependencies/sails.io.js"></script>
    <script src="/js/block.js"></script>
    <script src="/js/custom-script.js"></script>
    <script src="/js/FB.js"></script>
    <script src="/js/freewall.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/materialize.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/prism.js"></script>
    <!--SCRIPTS END-->
  </body>



</html>
